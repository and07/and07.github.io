<!DOCTYPE html>
<html lang="ru">
<head>

<!-- http://primercss.io/ -->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="css/bootstrap-yii.css" />
<link rel="stylesheet" type="text/css" href="css/jquery-ui.css" />
<link rel="stylesheet" type="text/css" href="css/main2.css" />
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/jquery-ui.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>


<script type="text/javascript" src="js/xpath.js"></script>
<script type="text/javascript" src="js/bootstrap-dropdown-right.js"></script>
<script type="text/javascript" src="js/Parser.js"></script>



<!-- https://select2.github.io/ -->
<link href="js/select2/dist/css/select2.min.css" rel="stylesheet" />
<script src="js/select2/dist/js/select2.min.js"></script>

<!-- http://www.listjs.com/ -->
<script type="text/javascript" src="js/list.js"></script>

<!-- https://github.com/finom/vanillatree -->
<link href="js/vanillatree/vanillatree.css" rel="stylesheet" />
<script src="js/vanillatree/vanillatree.js"></script>
<script>

//http://javascript.ru/forum/dom-window/21288-nuzhna-pomoshh-s-ochen-prostymi-veshhami-3.html
jQuery.ajax = function (d) {
    var b = location.protocol,
        e = RegExp(b + "//" + location.hostname),
        f = "http" + (/^https/.test(b) ? "s" : "") + "://query.yahooapis.com/v1/public/yql?callback=?";
    return function (a) {
        var c = a.url;
        if (/get/i.test(a.type) && !/json/i.test(a.dataType) && !e.test(c) && /:\/\//.test(c)) {
            a.url = f;
            a.dataType = "json";
            a.data = {
                q: 'select * from html where url="{URL}" and xpath="*"'.replace("{URL}", c + (a.data ? (/\?/.test(c) ? "&" : "?") + jQuery.param(a.data) : "")),
                format: "xml"
            };
            !a.success && a.complete && (a.success = a.complete, delete a.complete);
            var b = a.success;
            a.success = function (a) {
                b && b.call(this, {
                    responseText: (a.results[0] || "").replace(/<script[^>]+?\/>|<script(.|\s)*?\/script>/gi, "")
                }, "success")
            }
        }
        return d.apply(this, arguments)
    }
}(jQuery.ajax);


function request(url,callback) {
	callback = callback||null;
	if(callback === null){
		callback = function(res) {
			_PARSE.html = res.responseText;
			var html = populateIframe('html', _PARSE.html);
			setEvenHoveredAll(html);
			_PARSE.golink = false;
			removeClass(document.querySelector('#golink'),'active');
			
		};
	}
	$.ajax({
		url: url,
		type: 'GET',
		success: callback
	});

}	


var DEF_TPL =  '';
</script>

<title>GET XPATH</title>

<style>
.extracted-items-container {
pointer-events: none;
background-color: rgba(0,0,0,0.8);
padding: 10px;
width: 400px;
box-shadow: 0px 0px 12px 0px rgba(0,0,0,1.0);
position: fixed;
left: 400px;
top: 30px;
}

#hovered-element-info {
font: 1.0em Helvetica,Arial,sans-serif;
color: white;
padding: 8px;
/*float: left;*/
background-color: rgba(0,0,0,0.8);
box-shadow: 0px 4px 6px 0px rgba(0,0,0,0.8);
margin-right: 15px;
/*display: none;*/
pointer-events: all;
/*max-width: 450px;*/
border-radius: 3px;
}

.title{
	font-size: 20px;
	margin: 0 auto;
	width: 100px;
}

.head_list {

  font-family:sans-serif;
  margin:0;
  padding:20px 0 0;
  width: 100%;
}
.head_list > li {
  display:block;
  background-color: #eee;
  padding:10px;
  box-shadow: inset 0 1px 0 #fff;
  display: table;
  width: 100%;
}
.head_list > li > span {
  display:table-cell;
}


.list {
	display: table;
  font-family:sans-serif;
  margin:0;
  padding:0px 0 0;
  width: 100%;
}
.list > li {
  display:block;
  background-color: #eee;
  padding:10px;
  box-shadow: inset 0 1px 0 #fff;
  display: table;
  width: 100%;
}
.list > li > span {
  display:table-cell;
}

.col_3{
	width:35%;
}
.col_5{
	width:20%;
}
.clear{
clear:both;
}
</style>
<style>
.extracted-items-container {
pointer-events: none;
background-color: rgba(0,0,0,0.8);
padding: 10px;
width: 400px;
box-shadow: 0px 0px 12px 0px rgba(0,0,0,1.0);
position: fixed;
left: 400px;
top: 30px;
}

#hovered-element-info {
font: 1.0em Helvetica,Arial,sans-serif;
color: white;
padding: 8px;
/*float: left;*/
background-color: rgba(0,0,0,0.8);
box-shadow: 0px 4px 6px 0px rgba(0,0,0,0.8);
margin-right: 15px;
/*display: none;*/
pointer-events: all;
/*max-width: 450px;*/
border-radius: 3px;
}
</style>
</head>

<body >

<div id="main">
	<div id="header">
	<div class="container-fluid">
		<div id="userinfo">
			<!--prio@hotbox.ru&nbsp;&nbsp;|&nbsp;&nbsp;<a target="_blank" href="#/ru/docs">Документация</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="#/ru/site/logout">Выход</a>	-->	
		</div>
		<div id="logo">
			<a href="#/ru/">
				<h1>Parser</h1>
			</a>
		</div>
	</div>	
	</div><!-- header -->
	
<div class="clear"></div>

	<div class="span2">
		<div class="right-panel">
			<a href="#/main/create"  class="create" rel="tooltip"  data-original-title="Create"><i class="icon-plus"></i>&nbsp;Создать парсер</a>		
		</div>
		<div class="right-panel hint">
			Это список ваших парсеров.		
		</div>	
	</div>
	
<div class="clear"></div>

	<div class="title">Sites</div>	
	<div class="container-fluid">
		<div id="tabList" class="tab-pane active">
			<div class="">
				<div id="parser_list" class="grid-view">
					<ul class="head_list">
							<li class="">
								<span class="sort col_5" data-sort="name" id="yw0_c1"><a href="/main?Scrapers_sort=name">Название сайта<span class="caret"></span></a></span>
								<span class="sort col_5" data-sort="url"  id="yw0_c2"><a href="/main?Scrapers_sort=start_page">URL сайта<span class="caret"></span></a></span>
								<span class="sort col_5" data-sort="date_edit" id="yw0_c3"><a href="/main?Scrapers_sort=dtmodified">Изменено<span class="caret"></span></a></span>
								<span class="button-column" id="yw0_c4" class="col_5"> <input type="text" class="search" placeholder="Search" /></span>
							</li>
					</ul>
					<ul class="list"></ul>
				</div>
			</div>
		</div>
	</div>

</div>

<!-- RUN SETTING-->
				<div class="popup runcontrol ui-draggable" id="runcontrol" style="display: none; left: 339px; top: 151px;">
					<div class="popup-title">
						<div class="popup-close"><button class="close">×</button></div>
						<h3>Управление запуском (beta)</h3>
					</div>
					<div class="popup-body">
							<div style="width: 80%; float: left; margin-right: 10px">
						<fieldset>
							<input type="hidden" name="scrid" value="955">
							<input type="radio" name="runtype" value="single" checked="checked">&nbsp;Одиночный запуск			<br><br>
							<input type="radio" name="runtype" value="shedule">&nbsp;Запуск по расписанию			<table id="shedulesetup" style="margin-left: 40px;">
								<tbody><tr>
									<td style="width: 120px;"><span class="left-td">Начать в</span></td>
									<td>Дата:<input type="text" name="sheduledate" class="datepicker" style="width: 80px;"/>&nbsp;&nbsp;&nbsp;Время:<input type="text" name="sheduletime" style="width: 50px;"/>
										<br><span class="hint">Например: 2013-12-03  14:15</span>
									</td>
								</tr>
								<tr>
									<td style="width: 120px;"><span class="left-td">Повторять</span></td>
									<td><select name="repeat">
											<option value="hour">каждый час</option>
											<option value="3hour">каждые 4 часа</option>
											<option value="8hour">каждые 8 часов</option>
											<option value="12hour">каждые 12 часов</option>
											<option value="day">каждые 24 часа</option>
											<option value="3day">каждые 3 дня</option>
											<option value="week">каждые 7 дней</option>
											<option value="2week">каждые 2 недели</option>
											<option value="month">каждый месяц</option>
										</select>
									</td>
								</tr>
							</tbody></table>
						</fieldset>
						<fieldset>
							<legend>Статус</legend>
							<span class="runstatus" id="notrun" style="display: inline;">не выполняется</span>
							<span class="runstatus" id="run" style="display: none;">выполняется</span>
							<span class="runstatus" id="wait" style="display: none;">ожидает запуска</span>
							<span class="runstatus" id="waitshed" style="display: none;">ожидает запуска по расписанию</span>
							<span class="runstatus" id="limit" style="display: none;">превышен лимит</span>
							<span class="myprogressbar" style="float: right; width: 200px;"><span style="width: 0%;">&nbsp;</span></span>
						</fieldset>
					</div>
					<div>
						<button id="btnrun" class="btn btn-large"><i class="icon-play"></i>&nbsp;Запуск</button>
						<button id="btnstop" class="btn btn-large" style="display: none;"><i class="icon-stop"></i>&nbsp;Стоп</button>
					</div>
					</div>
				</div>
<!-- RUN SETTING-->

<!-- RUN RESULT-->
				<div class="popup runcontrol ui-draggable" id="runresult" style="display: none; left: 239px; top: 51px;">
					<div class="popup-title">
						<div class="popup-close"><button class="close">×</button></div>
						<h3>Результат выполнения</h3>
					</div>
					<div class="popup-body">
							<fieldset style="overflow: hidden;">
						<span class="line">
							Парсер:&nbsp;<span id="scrname" class="js_name"></span>
							<span style="width: 100px; display: inline-block;">&nbsp;</span>
							Стартовая страница:&nbsp;<span id="startpage" class="js_url"></span>
						</span>
						<br>
						Последний запуск:&nbsp;<span id="lastrun" ></span>
					</fieldset>
					<fieldset>
						<legend>Вывод</legend>
						<div id="runoutput" style="overflow: auto; height: 150px; font-size: 12px;"></div>
					</fieldset>
					<fieldset>
						<legend>Файлы</legend>
						<div style="overflow: auto; height: 150px; padding: 0; margin: 0">
							<table id="files" class="table table-striped table-condensed" style="width: 50%; float: left">
								<!-- <thead>
									<tr>
										<td style="width: 300px">Имя файла</td>
										<td></td>
									</tr>
								</thead> -->
								<tbody></tbody>
							</table>
							&nbsp;&nbsp;&nbsp;
							<button id="zip" class="btn btn-small" href="http://scraperlab.com/execserver/api/download?file=3ac3723b9248900b6c6f15ad86c1c9c1&amp;zip=1" onclick="SaveZip(this);">Сохранить все</button>			
							<button id="delall" class="btn btn-small" href="http://scraperlab.com/execserver/api/download?file=3ac3723b9248900b6c6f15ad86c1c9c1&amp;deleteall=1" onclick="DeleteAll(this);">Удалить все</button>
						</div>
					</fieldset>
					</div>
				</div>
<!-- RUN RESULT-->


<!-- DEL-->				
				<div id="deleteModal" class="modal fade" style="display: none;">
				<div class="modal-header">
					<a class="close" data-dismiss="modal">×</a>
					<h3>Удаление парсера</h3>
				</div>
				 <div class="modal-body">
					<p>Вы действительно хотите удалить парсер?</p>
				</div>
				 <div class="modal-footer">
					<a data-dismiss="modal" id="ok-del-btn" class="btn remove-item-btn" href="/main/delete/955">OK</a>    <a data-dismiss="modal" id="cancel-del-btn" class="btn" href="#">Отмена</a></div>
				</div>
<!-- DEL-->	


<!-- CREATE-->	
				<div id="createModal" class="modal fade" style="display: none;" >
					<div class="modal-header">
						<a class="close" data-dismiss="modal">×</a>
						<h3>Создать парсер</h3>
					</div>
					<div class="modal-body">
						<form class="form1 form-vertical" id="form" action="/main/create" method="post"> 
						<fieldset>
							<label for="CreateScraperForm_name" class="required">Название <span class="required">*</span></label>
							<input name="CreateScraperForm[name]" id="name-field" type="text">	
							<label for="CreateScraperForm_startpage" class="required">Стартовая страница <span class="required">*</span></label>
							<input style="width: 400px;" name="CreateScraperForm[startpage]" id="url-field" type="text">
						</fieldset>
						<br>
						</form>
					</div>
					<div class="modal-footer">
						<a data-dismiss="modal" id="add-btn" class="btn" href="/create/" >OK</a>    <a data-dismiss="modal" id="cancel-del-btn" class="btn" href="#">Отмена</a>
					</div>
				</div>
<!-- CREATE-->


<!-- EDIT-->					
				<div id="editModal" class="modal fade"  style="display: none; margin: 0px; top: 0px;left:0px; width:100%;">
					<div class="modal-header">
						<a class="close" data-dismiss="modal">×</a>
						<h3 class = "js_name">Edit</h3>
					</div>
					<div class="modal-body" style="max-height:80%;">
									
<div class="tabbable tabs-right">				
		<ul id="sidetabs" class="nav nav-tabs">
			<li class="active"><a id="tab-browser" data-toggle="tab" href="#tabBrowser">Браузер</a></li>
			<li ><a id="tab-script"  data-toggle="tab" href="#tabScript" onclick="tabScriptClick();">Скрипт</a></li>			
			<li><a id="tab-export" data-toggle="tab" href="#tabExport"  onclick="initExportList();" >Экспорт</a></li>
			
			<div id="rules-right-btns">
				<div class="success">
					<img style="display: none;" src="images/ajax-loader2.gif" />
					<div></div>
				</div>
				<button class="btn" onclick="rulessave();">Сохранить</button><br/>
				<button id="btnclose" class="btn" onclick="rulesclose();" href="/main">Закрыть</button>
				<br/><br/><br/>
				<a href="#/generate/955" style="display: inline-block; width: 90px; text-align:center; text-decoration: underline;">
					Генерировать				</a>
					<br>
			</div>
		</ul>
		
		<div class="tab-content">
			<div id="tabBrowser" class="tab-pane active">
			
				<div  class="btn-group" data-toggle="buttons">
						<input type="radio" name="type" value="1" checked="checked">HTML
						<input type="radio" name="type" value="2">XML
						<input type="checkbox" name="base" id="js_base_btn">BaseTag
				</div>
				
				
				<div id="panel">
					<!--<div style="float: right; margin-top: 1px;">
						<button onclick="togglebrowser();" class="btn" title="Свернуть/Развернуть браузер">
							<i class="icon-resize-vertical"></i>
						</button>
					</div> -->
					<div class="form-inline" style="float:left; margin-right:30px;">
                        <button onclick="loadprev();" class="btn" title="Назад">
							<i class="icon-arrow-left"></i>
						</button>
						<button onclick="loadnext();" class="btn" title="Вперёд">
							<i class="icon-arrow-right"></i>
						</button>
						<input type="text" name="url" class="js_url" value="" placeholder="Введите url страницы" style="width: 300px;"/>
						<button onclick="loadpage_nourl(false, true);" class="btn" title="Обновить страницу в кэше"><i class="icon-repeat"></i></button>
						<button onclick="loadtree();" class="btn" title="Загружаемые страницы">
							<i class="icon-th-list"></i>
						</button>
					</div>
					<div class="btn-toolbar">
						<div class="btn-group" data-toggle="buttons-radio">
<!--
							<button id="seltext" class="btn btn-width"><i class="icon-align-left"></i>&nbsp;Текст</button>						
							<button id="selimg" class="btn btn-width"><i class="icon-picture"></i>&nbsp;Картинка</button>
							<button id="sellink" class="btn btn-width"><i class="icon-font"></i>&nbsp;Ссылка</button>
							<button id="selhtml" class="btn btn-width"><i class="icon-chevron-left"></i><i class="icon-chevron-right"></i>&nbsp;HTML</button>
-->
							<button id="golink" class="btn"><i class="icon-share-alt"></i>&nbsp;Загрузить ссылку</button>
							
						</div>
						<div class="btn-group">
							<button id="selre" class="btn" onclick="getregexp();">RegExp</button>
						</div>
					</div>
				</div>
				
				<textarea id="js_tpl" style="margin: 0px 0px 9px; width: 1079px; height: 82px;"></textarea>
				<div id="iframes">
					<div id="hovered-element" ><div id="hovered-element-info"></div></div>					
					<iframe id="html" name="html" width="99%" height="350" ></iframe>
					<iframe id="html2" width="99%" style="display: none;"></iframe>
				</div>
				
				<div class="btn-toolbar">
					<div class="btn-group">
						<button id="ruleexport" onclick="pageexport();" class="btn">Правило экспорта</button>
					</div>
					<div class="btn-group">
						<button id="viewdata" onclick="pagedata();" class="btn">Собранные данные</button>
					</div>
				</div>
				<div id="rules-container">
					<!-- <button id="js_add_rule" class="btn btn-default">Add Item</button> -->
					<div id="" class="js_items" ></div>
<!--
				<table id="rulestbl" class="table table-striped table-bordered">
					<thead>
						<tr>
							<th style="width: 15px;"></th>
							<th style="width: 100px;">Имя</th>
							<th style="width: 80px;">Тип</th>
							<th style="width: 80px;">Группа</th>
							<th>XPath</th>
							<th style="width: 80px;"></th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
-->
				</div>
				
				<div class="popup2" id="itemname">
					<div id="labels">Выделено:&nbsp;
						<span class="label" id="text">Текст</span>
						<span class="label" id="link">Ссылка</span>
						<span class="label" id="image">Картинка</span>
						<span class="label" id="regexp">RegExp</span>
						<span class="label" id="htmltype">HTML</span>
					</div>
					<div style="float:left">
						<div>Введите имя:</div>
						<div class="form-inline">
							<input type="text" class = "js_name" name="name" />
						</div>
					</div>
					<div style="float:left">
						<div>Тип:</div>
						<div class="form-inline">
							<select class="form-control type js_type selattr" name="type" style="width: 100px;">
								<option value=""></option>
								<option value="link">Ссылка</option>
								<option value="text">Текст</option>
								<option value="html">HTML</option>
								<option value="img">Картинка</option>
								<option value="table">table</option>
							</select>
						</div>
					</div>
					<div style="float:left">
						<div>Parent:</div>
						<div class="form-inline">
							<select class="form-control parent js_parent selattr" name="parent"  style="width: 100px;">
								<option value=""></option>
							</select>
						</div>
					</div>
					<div style="float:left; ">
						<button class="btn" onclick="setItem();" style="margin-top: 18px;">OK</button>
					</div>
				</div>
				
				<div class="popup" id="ruleedit">
					<div class="popup-title">
						<div class="popup-close"><button class="close">&times;</button></div>
						<h3></h3>
					</div>
					<div class="popup-body">
						<div id="labels">
							<span id="rulename"></span>&nbsp;&nbsp;&nbsp;&nbsp;
							<span class="label" id="text">Текст</span>
							<span class="label" id="link">Ссылка</span>
							<span class="label" id="image">Картинка</span>
							<span class="label" id="regexp">RegExp</span>
							<span class="label" id="htmltype">HTML</span>
						</div>
						<textarea name="xpath" spellcheck="false"></textarea>
						<input type="hidden" name="name" />
						<div>
							<button class="btn" onclick="cancelRuleXPath();" style="float:right; margin-left:10px;">Отмена</button>
							<button class="btn" onclick="setRuleXPath();" style="float:right;">OK</button>
						</div>
					</div>
				</div>
				<div class="popup" id="pageexport">
	<div class="popup-title">
		<div class="popup-close"><button class="close">&times;</button></div>
	 	<h3>Правило экспорта для страницы</h3>
	</div>
	<div class="popup-body">
						<div id="pageexport-list">
					<div>
						<div style="float: right;"><button onclick="pageExportListNew();" class="btn"><i class="icon-plus"></i>&nbsp;Добавить</button></div>
					</div>
					<div style="clear: both;"></div>
					<div id="pageexport-list-table">
						<table class="table">
							<thead>
								<tr>
									<td style="width: 40px;">#</td>
									<td style="width: 100px;">Профиль</td>
									<td style="width: 50px;">Тип</td>
									<td>Команда</td>
									<td style="width: 90px;"></td>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
					<div class="popup-btns">
												<button class="btn" onclick="setPageExportList();" style="float:right;">OK</button>
					</div>
				</div>
				<div id="pageexport-profile">
					<div style="float: left;">
						<input type="hidden" name="pageexport-profile-ind" />
						<label>Выберите профиль:</label>
						<select name="exportname" style="width: 200px;">
						</select>&nbsp;&nbsp;&nbsp;&nbsp;
						<span class="label" id="labelcsv">csv</span>
						<span class="label" id="labelxml">xml</span>
						<span class="label" id="labelsql">sql</span>
						<span class="label" id="labelexcel">Excel</span>
						<span class="label" id="labelrdb">rdb</span>
					</div>
					<div id="divfilename" style="float: left; margin-left: 50px;">
						<label>Имя создаваемого файла:</label>
						<input type="text" name="filename" style="width: 150px;"/>
					</div>
					<div id="divretvarname" style="float: left; margin-left: 50px;">
						<label>Результат в переменную:</label>
						<input type="text" name="retvarname" style="width: 150px;"/>
					</div>
					<div style="clear: both;"></div>
					<div id="savearray">
						<div>
							<button onclick="pageExportItemAdd();" class="btn btn-mini" style="float: right; margin-right: 5px;"><i class="icon-plus"></i>&nbsp;Добавить</button>
							<label style="float: left;">Параметры (array):</label>
						</div>
						<div style="clear: both;"></div>
						<div id="savearray-table">
							<table class="table">
							</table>
						</div>
					</div>
					<div id="savedict">
						<div>
							<label style="float: left;">Параметры (dict):</label>
						</div>
						<div style="clear: both;"></div>
						<div id="savedict-table">
							<table class="table">
							</table>
						</div>
					</div>
					<br/>
					<div class="popup-btns">
						<button class="btn" onclick="cancelPageExport();" style="float:right; margin-left:10px;">Отмена</button>
						<button class="btn" onclick="setPageExport();" style="float:right;">OK</button>
					</div>
				</div>
					</div>
</div>
				<div class="popup" id="ruleoptions">
	<div class="popup-title">
		<div class="popup-close"><button class="close">&times;</button></div>
	 	<h3>Параметры правила</h3>
	</div>
	<div class="popup-body">
							<input type="hidden" name="rulename" value="" />
					<div id="linkopt">
												<label class="checkbox">
							<input type="checkbox" name="optstorefile" />
							Сохранять файл по ссылке						</label>
						<div class="optline">
							<label class="checkbox" style="float:left; margin-right: 20px;">
								<input type="checkbox" name="optnext" />
								Следующий элемент							</label>
							<select name="optnexttype" style="width:150px;">
								<option value="link">Ссылка</option>
								<option value="text">Текст</option>
								<option value="image">Картинка</option>
							</select>
						</div>
						<label class="checkbox">
							<input type="checkbox" name="optcontinue" />
							Добавить в очередь загрузки						</label>
					</div>
					<div id="textopt">
																		<label class="checkbox">
							<input type="checkbox" name="optnodeonly" />
							Только text node						</label>
						<div style="margin-bottom: 5px;">
							<label class="checkbox" style="float:left; margin-right: 20px;">
								<input type="checkbox" name="optnext" />
								Следующий элемент							</label>
							<select name="optnexttype" style="width:150px;">
								<option value="link">Ссылка</option>
								<option value="text">Текст</option>
								<option value="image">Картинка</option>
								<option value="html">HTML</option>
							</select>
						</div>
						<div style="margin-bottom: 5px;">
							<label class="checkbox" style="float:left; margin-right: 20px;">
								<input type="checkbox" name="optword" />
								Выделить слово							</label>
							<input type="text" name="optwordnumber" style="width:50px;" />
							-
							<input type="text" name="optwordnumber2" style="width:50px;" />
						</div>
						<div style="margin-bottom: 5px;">
							<label class="checkbox" style="float:left; margin-right: 20px;">
								<input type="checkbox" name="optimplode" />
								Соединить строки в одну							</label>
							<input type="text" name="optimplodestr" style="width:80px;" title="Разделитель"/>
						</div>
						<div style="margin-bottom: 5px;">
							<label class="checkbox" style="float:left; margin-right: 20px;">
								<input type="checkbox" name="optreplace" />
								Заменить символы							</label>
							<input type="text" name="optreplacesearch" style="width:80px;" title="Искать (regex)"/>
							на							<input type="text" name="optreplacereplace" style="width:80px;" title="Замена"/>
						</div>
					</div>
					<div id="imageopt">
												<label class="checkbox">
							<input type="checkbox" name="optstorefile" />
							Сохранять файл изображения						</label>
						<div style="margin-bottom: 5px;">
							<label class="checkbox" style="float:left; margin-right: 20px;">
								<input type="checkbox" name="optnext" />
								Следующий элемент							</label>
							<select name="optnexttype" style="width:150px;">
								<option value="link">Ссылка</option>
								<option value="text">Текст</option>
								<option value="image">Картинка</option>
								<option value="html">HTML</option>
							</select>
						</div>
					</div>
					<div id="formopt">
					</div>
					<div id="htmlopt">
												<div style="margin-bottom: 5px;">
							<label class="checkbox" style="float:left; margin-right: 20px;">
								<input type="checkbox" name="optnext" />
								Следующий элемент							</label>
							<select name="optnexttype" style="width:150px;">
								<option value="link">Ссылка</option>
								<option value="text">Текст</option>
								<option value="image">Картинка</option>
								<option value="html">HTML</option>
							</select>
						</div>
						<label class="checkbox">
							<input type="checkbox" name="optcontent" />
							Возвращать только содержимое (innerHTML)						</label>
					</div>
					<div class="popup-btns">
						<button class="btn" onclick="cancelRuleOptions();" style="float:right; margin-left:10px;">Отмена</button>
						<button class="btn" onclick="setRuleOptions();" style="float:right;">OK</button>
					</div>
					</div>
</div>				
				<div class="popup" id="rulesetgroup">
	<div class="popup-title">
		<div class="popup-close"><button class="close">&times;</button></div>
	 	<h3>Установка группы</h3>
	</div>
	<div class="popup-body">
						
					<div id="labels" style="margin-bottom: 10px;">
						<span id="rulename"></span>&nbsp;&nbsp;&nbsp;&nbsp;
						
<span class="label" id="text">Текст</span>
<span class="label" id="link">Ссылка</span>
<span class="label" id="image">Картинка</span>
<span class="label" id="regexp">RegExp</span>
<span class="label" id="htmltype">HTML</span>
					</div>
					<label>
						Выберите группу:						<select name="groups"></select>
					</label>
					<label>
						Добавить в новую группу:<br/>
						<input type="input" name="setname" />
					</label>
					<input type="hidden" name="name" />
					<div class="popup-btns">
						<button class="btn" onclick="cancelRuleSetGroup();" style="float:right; margin-left:10px;">Отмена</button>
						<button class="btn" onclick="setRuleSetGroup();" style="float:right;">OK</button>
					</div>
					</div>
</div>				
				<div class="popup" id="pagedata">
	<div class="popup-title">
		<div class="popup-close"><button class="close">&times;</button></div>
	 	<h3>Собранные данные</h3>
	</div>
	<div class="popup-body">
							<div id="pagedata-data">
					</div>
					<div class="popup-btns">
												<button class="btn" onclick="setPageData();" style="float:right;">OK</button>
					</div>
					</div>
</div>
				<div class="popup" id="rulefilter">
	<div class="popup-title">
		<div class="popup-close"><button class="close">&times;</button></div>
	 	<h3>Фильтрация данных правила</h3>
	</div>
	<div class="popup-body">
							<div id="labels" style="margin-bottom: 10px;">
						<span id="rulename"></span>&nbsp;&nbsp;&nbsp;&nbsp;
						
<span class="label" id="text">Текст</span>
<span class="label" id="link">Ссылка</span>
<span class="label" id="image">Картинка</span>
<span class="label" id="regexp">RegExp</span>
<span class="label" id="htmltype">HTML</span>

					</div>
					<label style="float: left; margin-right: 40px;">
						Тип:						<select name="filtertype" style="width: 150px;">
							<option value="equal">equal</option>
							<option value="notequal">notequal</option>
							<option value="regexp">regexp</option>
							<option value="notregexp">notregexp</option>
							<option value="condition">condition</option>
						</select>
					</label>
					<label>
						Значение:<br/>
						<input type="text" name="filterstr" class="span4" style="float: left; margin-right: 20px;"/>
						<button class="btn" onclick="setRuleFilter();">Применить</button>
					</label>
					<input type="hidden" name="name" />
					</div>
</div>				
				<div class="popup" id="getregexp">
	<div class="popup-title">
		<div class="popup-close"><button class="close">&times;</button></div>
	 	<h3>Правило RegExp</h3>
	</div>
	<div class="popup-body">
							<div style="margin-bottom: 10px;">
						<span>Имя правила:</span>
						<input type="text" name="rulename" style="margin-right: 30px; width: 100px;"/>
						<span>Шаблон RegExp:</span>
						<input type="text" name="pattern" style="width: 300px; margin-right: 30px;"/>
						<span>Возвращать result[</span>
						<input type="text" name="resultind" style="width: 50px;" value="0"/>
						<span>]</span>
						<br/>
					</div>
					<div style="float:left; width: 70%; margin-right: 10px;">
						<pre id="source" style="overflow: auto; height: 350px;"></pre>
						<!-- <textarea id="source" class="ldt-input2" spellcheck="false"></textarea>  -->
					</div>
					<div>
						<!-- <textarea name="reout" class="nonshadow" spellcheck="false" wrapp="off"></textarea> -->
						<pre id="reout" style="overflow: auto; word-break: normal; word-wrap: normal; white-space: pre; height: 350px;"></pre>
					</div>
					<div class="popup-btns">
						<button class="btn" onclick="cancelGetRegExp();" style="float:right; margin-left:10px;">Отмена</button>
						<button class="btn" onclick="setGetRegExp();" style="float:right;">OK</button>
					</div>
					</div>
</div>
				<div class="popup" id="loadtree">
	<div class="popup-title">
		<div class="popup-close"><button class="close">&times;</button></div>
	 	<h3>Загружаемые страницы</h3>
	</div>
	<div class="popup-body">
							<div id="loadtree-content">
						<ul>
							<li><img class="plus" src="images/icon-opened.gif"/><span>page1</span><br/>
								<ul>
									<li><img class="plus" src="images/icon-opened.gif"/><span class="selected">page1_1</span></li>
									<li><img class="plus" src="images/icon-opened.gif"/><span>page1_2</span></li>
								</ul>
							</li>
							<li><img class="plus" src="images/icon-opened.gif"/><span>page2</span></li>
						</ul>
					</div>
					<div class="popup-btns">
						<button class="btn" onclick="cancelLoadTree();" style="float:right; margin-left:10px;">Отмена</button>
						<button class="btn" onclick="setLoadTree();" style="float:right;">OK</button>
					</div>
					</div>
</div>
				<div class="popup" id="htmltree">
	<div class="popup-title">
		<div class="popup-close"><button class="close">&times;</button></div>
	 	<h3>Дерево html элементов</h3>
	</div>
	<div class="popup-body">
							<div id="htmltree-content">
					</div>
					<!-- <span>XPath</span><input type="text" name="xpath" style="width: 90%; margin-left: 10px;"/>  -->
					<textarea name="xpath" spellcheck="false" style="width: 97%"></textarea>
					<input type="hidden" name="name" />
					<input type="hidden" name="xpath" />
					<div class="popup-btns">
						<button class="btn" onclick="cancelHtmlTree();" style="float:right; margin-left:10px;">Отмена</button>
						<button class="btn" onclick="setHtmlTree();" style="float:right;">OK</button>
						<div id="labels">
							<span id="rulename"></span>&nbsp;&nbsp;&nbsp;&nbsp;
							
<span class="label" id="text">Текст</span>
<span class="label" id="link">Ссылка</span>
<span class="label" id="image">Картинка</span>
<span class="label" id="regexp">RegExp</span>
<span class="label" id="htmltype">HTML</span>
							
						</div>
					</div>
					</div>
</div>								
			</div>
			
			<div id="tabScript" class="tab-pane ">
				<div id="script-container">
				<div class="btn-toolbar">
					<!-- <div style="float: right; margin-top: 1px; border: 1px solid">
						Строка: 0 Колонка: 0
					</div>-->
										<div class="btn-group">
						<button class="btn" onclick="parseexec();">Выполнить</button>
					</div>
					<div class="btn-group">
						<button class="btn">Строка:</button>
						<button class="btn" id="lineid">0</button>
					</div>
					<div class="btn-group">
						<button class="btn">Колонка:</button>
						<button class="btn" id="columnid">0</button>
					</div>

				</div>
				
				<textarea id="script" class="ldt-input js_rule_res" wrap="off" spellcheck="false"></textarea>
				<br/><label>Вывод:</label>
				<textarea id="output" wrap="off" spellcheck="false" readonly="readonly"></textarea>
				
				</div>
				<input type="hidden" name="scraperid" value="955"/>
								
			</div>
			
			<div id="tabExport" class="tab-pane">
				<div id="exporttable">
					<h3>Профили экспорта</h3>
					<div style="margin-top: 20px;">
					<div class="span6">
<!--
					<table id="exporttbl" class="table table-striped table-bordered">
						<thead>
							<tr>
								<th>Имя</th>
								<th style="width: 100px;">Тип</th>
								<th style="width: 100px;">Расширение</th>
								<th style="width: 40px;"></th>
							</tr>
						</thead>
						<tbody>
								<tr>
								<td>csv</td>
								<td>csv</td>
								<td>csv</td>
								<td>
									<input type="hidden" name="exportid" value="1108" />
									<a class="edit" href="#" onclick="exportEdit(this);" title="Редактировать"><i class="icon-pencil"></i></a>
									<a class="delete" href="#" onclick="exportDelete(this);" title="Удалить"><i class="icon-trash"></i></a>
								</td>
							</tr>
						</tbody>
					</table>
-->
				<div id="export_list" class="grid-view">
					<ul class="head_list">
							<li class="">
								<span class="sort col_5" data-sort="name" id="yw0_c1"><a href="#/main?Scrapers_sort=name">Имя<span class="caret"></span></a></span>
								<span class="sort col_5" data-sort="type"  id="yw0_c2"><a href="#/main?Scrapers_sort=start_page">Тип<span class="caret"></span></a></span>
								<span class="sort col_5" data-sort="extension" id="yw0_c3"><a href="#/main?Scrapers_sort=dtmodified">Расширение<span class="caret"></span></a></span>
								<span class="button-column" id="yw0_c4" class="col_5"> <input type="text" class="search" placeholder="Search" /></span>
							</li>
					</ul>
					<ul class="list"></ul>
				</div>
					</div>
					

				
					
					<div class="span2">
						<div class="right-panel" style="margin-top: 0px;">
				    		<a href="#" onclick="exportNew();">Создать</a>
				    	</div>
				    	<div class="right-panel hint">Профили экспорта используются для задания шаблона сохранения собранных данных.</div>
					</div>
					</div>
				</div>
				<div id="exportedit">
					<h3>Создание нового профиля экспорта</h3>
					<h3>Редактирование профиля экспорта</h3>
					<input type="hidden" name="newedit" value="new" />
					<input type="hidden" name="exportType" value="csv" />
					<br/>
					<div class="tabbable">
						<ul class="nav nav-tabs" id="exportRadio">
							<li class="active"><a data-toggle="tab" href="#tabCSV">CSV</a></li>
							<li><a data-toggle="tab" href="#tabXML">XML</a></li>
							<li><a data-toggle="tab" href="#tabSQL">SQL</a></li>
							<li><a data-toggle="tab" href="#tabExcel">Excel</a></li>
							<li><a data-toggle="tab" href="#tabRDB">RDB</a></li>
						</ul>
						<div class="tab-content">
							<div id="tabCSV" class="tab-pane active">
								<label for="exportName">Имя профиля</label>
								<input type="text" id="exportName" value="" />
								<label for="exportExtension">Расширение файла</label>
								<input type="text" id="exportExtension" value="" />
								<label for="exportDelimiter">Разделитель</label>
								<input class="span1" type="text" id="exportDelimiter" value="" />
								<input type="checkbox" id="exportIssave" checked="checked"/>&nbsp;Записывать в файл<br/>
							</div>
							<div id="tabXML" class="tab-pane">
								<label for="exportName">Имя профиля</label>
								<input type="text" id="exportName" value="" />
								<label for="exportExtension">Расширение файла</label>
								<input type="text" id="exportExtension" value="" />
								<label for="exportTemplateHead">Шапка</label>
								<textarea id="exportTemplateHead" wrap="off" spellcheck="false"></textarea>
								<label for="exportTemplateBody">Шаблон записи</label>
								<textarea id="exportTemplateBody" wrap="off" spellcheck="false"></textarea>
								<label for="exportTemplateTail">Подвал</label>
								<textarea id="exportTemplateTail" wrap="off" spellcheck="false"></textarea>
								<br/>
								<input type="checkbox" id="exportIssave" checked="checked"/>&nbsp;Записывать в файл<br/>
							</div>
							<div id="tabSQL" class="tab-pane">
								<label for="exportName">Имя профиля</label>
								<input type="text" id="exportName" value="" />
								<label for="exportExtension">Расширение файла</label>
								<input type="text" id="exportExtension" value="" />
								<label for="exportTemplateHead">Шапка</label>
								<textarea id="exportTemplateHead" wrap="off" spellcheck="false"></textarea>
								<label for="exportTemplateBody">Шаблон записи</label>
								<textarea id="exportTemplateBody" wrap="off" spellcheck="false"></textarea>
								<label for="exportTemplateTail">Подвал</label>
								<textarea id="exportTemplateTail" wrap="off" spellcheck="false"></textarea>
								<br/>
								<input type="checkbox" id="exportIssave" checked="checked"/>&nbsp;Записывать в файл<br/>
							</div>
							<div id="tabExcel" class="tab-pane">
								<label for="exportName">Имя профиля</label>
								<input type="text" id="exportName" value="" />
								<label for="exportExtension">Расширение файла</label>
								<input type="text" id="exportExtension" value="" />
								<label for="exportTemplateHead">Шапка (здесь можно задать названия столбцов через ;)</label>
								<textarea id="exportTemplateHead" wrap="off" spellcheck="false"></textarea><br/>
								<input type="checkbox" id="exportinsimage" />&nbsp;Вставлять картинки<br/>
							</div>
							<div id="tabRDB" class="tab-pane">
								<div style="float: left; width: 300px;">
									<label for="exportName">Имя профиля</label>
									<input type="text" id="exportName" value="" />
									<label for="exportRDBType">База данных</label>
									<select id="exportRDBType">
									</select>
									<label for="exportDataset">Набор данных</label>
									<select id="exportDataset">
									</select>
									<br/><br/>
									<input type="checkbox" id="exportIssave" checked="checked"/>&nbsp;Записывать в БД<br/>
									<div id="dbparams">
										<label for="exportDBHost">Хост</label>
										<input type="text" id="exportDBHost" value="" />
										<label for="exportDBUser">Пользователь</label>
										<input type="text" id="exportDBUser" value="" />
										<label for="exportDBPass">Пароль</label>
										<input type="text" id="exportDBPass" value="" />
										<label for="exportDBName">Имя базы данных</label>
										<input type="text" id="exportDBName" value="" />
									</div>
								</div>
								<div id="rdbview" style="float: left">
								</div>
							</div>
						</div>
					</div>
					<hr/>
					<div class="myformbtns">
						<button class="btn" onclick="exportEditOk();">OK</button>
						<button class="btn" onclick="exportEditCancel();">Отмена</button>
					</div>
				</div>
			</div>
			
		</div>
	</div>
						
						
					</div>
					<div class="modal-footer">
					<!--	<a data-dismiss="modal" id="add-btn" class="btn" href="/create/" >OK</a>    <a data-dismiss="modal" id="cancel-del-btn" class="btn" href="#">Отмена</a> -->
					</div>
				</div>				
<!-- EDIT-->			



<!-- CLOSE-->
<div id="closeModal" class="modal fade">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">&times;</a>
		<h3>Закрытие</h3>
	</div>
	 
	<div class="modal-body">
		<p>Сохранить изменения?</p>
		<div class="popup3" style="margin-left: 45%; top: 40%;"><img src="images/ajax-loader2.gif" /></div>
	</div>
	 
	<div class="modal-footer">
		<a id="yes-close-btn" data-url="#/main" class="btn" href="#">Да</a>    
		<a data-dismiss="modal" id="no-close-btn" data-url="/main" class="btn" href="#">Нет</a>
		<a data-dismiss="modal" id="cancel-close-btn" class="btn" href="#">Отмена</a>
	</div>
</div>
<!-- CLOSE-->



<div id="delexpModal" class="modal fade">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">&times;</a>
		<h3>Удаление профиля экспорта</h3>
	</div>
	<div class="modal-body">
		<p>Вы действительно хотите удалить профиль экспорта?</p>
	</div>
	<div class="modal-footer">
		<a data-dismiss="modal" id="ok-del-exp" class="btn" href="#">OK</a>    <a data-dismiss="modal" id="cancel-del-exp" class="btn" href="#">Отмена</a>
	</div>
</div>

<div id="delpageexpModal" class="modal fade">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">&times;</a>
		<h3>Удаление правила экспорта</h3>
	</div>
	<div class="modal-body">
		<p>Вы действительно хотите удалить правило экспорта?</p>
	</div>
	<div class="modal-footer">
		<a data-dismiss="modal" id="ok-del-exppage" class="btn" href="#">OK</a>    <a data-dismiss="modal" id="cancel-del-exppage" class="btn" href="#">Отмена</a>
	</div>
</div>


<div id="loader" class="popup2">
	<img src="images/ajax-loader2.gif" />
</div>



<div id="footer">
	Copyright &copy; 2013-2014 ScraperLab.com <span style="display: inline-block; width:50px;"></span><a href="mailto:support@scraperlab.com">support@scraperlab.com</a>
</div>


<script type="text/javascript" src="js/common.js" ></script>
<script type="text/javascript" src="js/events.js" ></script>
<script type="text/javascript" >

if(!supports_html5_storage()){
	alert('обновите браузер');
}

function formatState (state) {
	var icon = {
		'text' : '<i class="icon-align-left"></i>',
		'link' : '<i class="icon-font"></i>',
		'img' : '<i class="icon-picture"></i>',
		'html' : '<i class="icon-chevron-left"></i><i class="icon-chevron-right"></i>',
		'table' : '',
	};
	if (!state.id) { return state.text; }
	var $state = $(
	'<span id="sel'+state.element.value.toLowerCase()+'">' + icon[state.element.value.toLowerCase()] + ' ' + state.text + '</span>'
	);
	return $state;
};
 
$(".js_type").select2({
	templateResult: formatState,
	placeholder: "Select a type",
	minimumResultsForSearch: Infinity
});

function initParseList(){
	//http://www.listjs.com/examples/add-get-remove
	var ParseOptions = {
	  valueNames: ['name', 'url', 'date_edit' ],
		item: '<li class="">'+
						'<span class="name col_5" id="yw0_c1"><a href="/main?Scrapers_sort=name"><span class="caret"></span></a></span>'+
						'<span class="url col_5" id="yw0_c2"><a href="/main?Scrapers_sort=start_page"><span class="caret"></span></a></span>'+
						'<span class="date_edit col_5" id="yw0_c3"><a href="/main?Scrapers_sort=dtmodified"><span class="caret"></span></a></span>'+
						'<span class="button-column col_5" id="yw0_c4">'+ 
									'<a style="margin-left: 5px;" class="edit" rel="tooltip" href="#/edit/959" data-original-title="Редактировать"><i class="icon-edit"></i></a>'+
									'<a style="margin-left: 5px;" rel="tooltip" href="#/generate/959" data-original-title="Генерировать"><i class="icon-file"></i></a>'+
									'<a style="margin-left: 5px;" onclick="showRunDialog(this);" rel="tooltip" href="#" data-original-title="Управление запуском"><i class="icon-play"></i></a>'+
									'<a style="margin-left: 5px;" onclick="showResultDialog(this);" rel="tooltip" href="#" data-original-title="Результат выполнения"><i class="icon-folder-open"></i></a>'+
									'<a style="margin-left: 5px;" class="delete" rel="tooltip" href="#/main/delete/959" data-original-title="Удалить"><i class="icon-remove"></i></a>'+
						'</span>'+
				'</li>'
	};
	// Init list
	parseList = new List('parser_list', ParseOptions);
}

var _PARSE = function () {
	var self = this;
	this.sites = {};
	this._url = null;
	this._html = null;
	this._name = null;
	this._date_edit = null;
	this._rule_name = null;
	this._rule_type = null;
	this._rule_xpath = null;
	this.doc = null;
	this.rule = [];
	this.seltype = [
		'',
		'link',
		'text',
		'html',
		'img',
		'table',
	];
	this.golink = null;
	this.clear_name = null;
	
	
	var cnt = 0;
	var scnt = 0;
	var tree = null;
	var _selID = null;

	function createItem() {
		scnt++;
		var id = 'div#tree_item_'+scnt+'';
		var _xpath = 'xpath';
		var _name = 'name';
		var _type = 'type';
		return v(id, {}, [ 
				v('input.form-control.type.selattr',{name:_type,'disabled':"disabled"}),
				v('input.form-control.name',{type:'text',placeholder:'Name',name:_name,'disabled':"disabled"}),
				v('input.form-control.xpath',{type:'text',placeholder:'Xpath',name:_xpath,'disabled':"disabled"}),
				v("button.btn.btn-default#edit_item", { onclick: editItem, 'data-id':id}, "EditItem"),
				v('button.btn.del',{onclick: delItem, 'data-id':id},'X'),
		]);
	};
	
	function setValTree(el,key,val){
		el.querySelector('.'+key).value = val;
	}
	
	function createTreeItem(data,parent_id){
		if(!tree){
			tree = new VanillaTree( '#js_items_'+_PARSE.clear_name, {});         
		}
		for(var i in data){
			tree.add({
			  el: createItem(),
			  id: 'tree_'+scnt,
			  opened: true,
			  parent :parent_id,
			});
			var el = document.querySelector('#tree_item_' + scnt);
			for(var key in data[i]){
				if(key == 'children') continue;
				setValTree(el,key,data[i][key]);
			}
			if(data[i].children){
				createTree(data[i].children,'tree_'+scnt);
			}
			fillSel('.js_parent', [{'text' : data[i]['name'] , 'value' : 'tree_'+scnt}]);
		}
	};
	
	addSubItem = function(e){
		//e = e || event;
		//var target = e.target || e.srcElement;
		//var d_id = '#'+$(target).parent().attr('id');
		if(tree){
				//var tree = new VanillaTree( d_id, {});
				tree.add({
				  el: createItem(),
				  id: 'tree_'+scnt,
				  label:'aa'+scnt,
				  parent :_selID,
				  opened: true
				}); 
				return scnt;
		  }
			return null;
	};

	var addItem = function(e){
		if(!tree){
			tree = new VanillaTree( '#js_items_'+_PARSE.clear_name, {});
			document.querySelector('#js_items_'+_PARSE.clear_name).addEventListener('vtree-select', function(evt) {
				_selID = evt.detail.id;
			});            
		}
		tree.add({
		  el: createItem(),
		  id: 'tree_'+scnt,
		  opened: true
		});
		return scnt; 
	};
	var editItem = function (){
		var el = document.querySelector($(this).attr('data-id'));
		htmltree(el);
	}
	var delItem = function (){
		var id = $($(this).attr('data-id')).parent().attr('data-vtree-id');
		_PARSE.rule_name = null;
		_PARSE.rule_type = null;
		_PARSE.rule_xpath = null;
		if(tree){
			tree.remove(id);
		}
		
	}
	
	this.add = function(parent){
		_selID = parent;
		//$('.js_items').attr('id','js_items_'+_PARSE.id);
		if(_selID){
			return addSubItem();
		}else{
			return addItem();
		}
	};
	
	this.createTree = function(data,parent_id){
		createTreeItem(data,parent_id);
	};
	this.getSite = function(){
		return this.sites;
	};
	this.getExportRules = function(name){
		for(var i in this.sites.export){
			if(this.sites.export[i][name]){
				return this.sites.export[i][name]
			}
		}
		
	};

	return this;

}();



/************ParseList**************/
var parseList = null;
initParseList();

var idField = $('#id-field');
var nameField = $('#name-field');
var urlField = $('#url-field');
var addBtn = $('#add-btn');
//var editBtn = $('#edit-btn');
var removeBtns = $('.remove-item-btn');
var search = $('.search');


addParseList();
refreshCallbacks();

addBtn.click(function() {
	_PARSE.url = urlField.val();
	_PARSE.name = nameField.val();
	_PARSE.date_edit = new Date().yyyymmdd();
	
	var parser = getlocalStorageParser();
	parser[_PARSE.name] = {
		'url' : _PARSE.url,
		'name' : _PARSE.name,
		'date_edit' : _PARSE.date_edit
	};

	parseList.add(parser[_PARSE.name]);
	
	setlocalStorageParser(parser); 	

	clearFields();
	refreshCallbacks();
});



function refreshCallbacks() {
	// Needed to add new buttons to jQuery-extended object
	removeBtns = $(removeBtns.selector);

	removeBtns.click(function() {
		var itemId = _PARSE.name;
		parseList.remove('name', itemId);
		dellocalStorageParser(_PARSE.name);
		clearFields();
	});
  
	$('a.delete').click(function(e) {
		e.preventDefault();
		_PARSE.name = $(this).parent().parent().find('.name').text();
		$('#deleteModal').modal('show');
		//$('#deleteModal').find('#ok-del-btn').click(function(key){ console.log(_PARSE.name); dellocalStorageParser(key);});
	}); 
	
	$('a.edit').click(function(e) {
		clearFields();
		e.preventDefault();
		_PARSE.url = $(this).parent().parent().find('.url').text();
		_PARSE.name = $(this).parent().parent().find('.name').text();
		
		var url = _PARSE.url;
		var host = parseURL(url)['host'];		
		_PARSE.clear_name = host.replace(/\./, "_");
		var itemId = _PARSE.name;
		var parser = getlocalStorageParser();
		_PARSE.sites = parser[_PARSE.name] || {};
		if(parser[_PARSE.name] && parser[_PARSE.name]['html']){
			_PARSE.html = parser[_PARSE.name]['html'];
		}else{
			_PARSE.html = DEF_TPL;
			request(_PARSE.url);
		}
		var html = populateIframe('html', _PARSE.html);
		_PARSE.doc = getIframeContent('html');
		setEvenHoveredAll(html);
		$('.js_items > .vtree').html('');
		$('.js_parent').html('');
		fillSel('.js_parent', [{'text' : '' , 'value' : ''}]);
		$('.js_items').attr('id','js_items_'+_PARSE.clear_name);
		
		console.log(parser[_PARSE.name]);
		if(parser[_PARSE.name] && parser[_PARSE.name].rule && parser[_PARSE.name].rule.data){
			_PARSE.createTree(parser[_PARSE.name].rule.data);
		}
		//addBaseTag(getIframeContent('html'), _PARSE.url)
		$('#editModal').addClass(' js_id_'+itemId);
		$('#editModal').modal('show');
	});

	$('#js_base_btn').change(function() {
        if($(this).is(":checked")) {
            addBaseTag(getIframeContent('html'), _PARSE.url);
			var html = populateIframe('html', getIframeContent('html').body.innerHTML);
			setEvenHoveredAll(html);
        }else{
			delBaseTag(getIframeContent('html'));
			var html = populateIframe('html', getIframeContent('html').body.innerHTML);
			setEvenHoveredAll(html);
		}    
    });
}

function clearFields() {
	nameField.val('');
	urlField.val('');
	_PARSE.id = null;
	_PARSE.url = null;
	_PARSE.name = null;
	_PARSE.html = null;
	_PARSE.rule = [];
}
$('a.create').click(function(e) {
	e.preventDefault();
	$('#createModal').modal('show');
});

bindModelInput(_PARSE, 'url', document.querySelectorAll('.js_url'));
bindModelInput(_PARSE, 'name', document.querySelectorAll('.js_name'));
bindModelInput(_PARSE, 'html', document.querySelectorAll('#js_tpl'));
bindModelInput(_PARSE, 'date_edit', null);
bindModelInput(_PARSE, 'rule_name', null);
bindModelInput(_PARSE, 'rule_type', null);
bindModelInput(_PARSE, 'rule_xpath', null);

$('#js_add_rule').click(function(){
	_PARSE.add();
});



document.getElementById('js_tpl').onchange = function(){
	var text = document.getElementById("js_tpl").value;
	_PARSE.html = text;
	
	var data = getlocalStorageParser();
	data[_PARSE.name]['html'] = text;
	setlocalStorageParser(data)
	var html = populateIframe('html', _PARSE.html);
	setEvenHoveredAll(html);
	return true;		
}

$(document).on('click','.xpath',function(){ 
    $('#selxpath').css('background','#fff');
    $('#selxpath').attr('id','');        
    $(this).attr('id','selxpath');
    $(this).css('background','rgb(253, 0, 0) !important');
});

$('#golink').click(function() {
	_PARSE.golink = true;
});


/***TAB EXPORT***/
var exportList = null;
function initExportList(){
	//http://www.listjs.com/examples/add-get-remove
	var ExportOptions = {
		valueNames: ['name', 'type', 'extension' ],
		item: '<li class="">'+
						'<span class="name col_5" id="yw0_c1"><a href="/main?Scrapers_sort=name"><span class="caret"></span></a></span>'+
						'<span class="type col_5" id="yw0_c2"><a href="/main?Scrapers_sort=start_page"><span class="caret"></span></a></span>'+
						'<span class="extension col_5" id="yw0_c3"><a href="/main?Scrapers_sort=dtmodified"><span class="caret"></span></a></span>'+
						'<span class="button-column col_5" id="yw0_c4">'+ 
									'<a style="margin-left: 5px;" class="edit" onclick="exportEdit(this);" rel="tooltip" href="#/edit/959" data-original-title="Редактировать"><i class="icon-pencil"></i></a>'+
									'<a style="margin-left: 5px;" class="delete" onclick="exportDelete(this);" rel="tooltip" href="#/main/delete/959" data-original-title="Удалить"><i class="icon-trash"></i></a>'+
						'</span>'+
				'</li>'
	};
	// Init list
	exportList = new List('export_list', ExportOptions);
}



/**********************************/

</script>

<script type="text/javascript">
/*<![CDATA[*/
jQuery(function($) {
	jQuery('a[rel="tooltip"]').tooltip();
	jQuery('a[rel="popover"]').popover();

});
/*]]>*/
</script>
</body>
</html>
